<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Control Center</title>
    <style>
        :root { --primary: #2e7d32; --accent: #2196F3; --bg: #f4f4f9; --card: #ffffff; --text: #333; --danger: #d32f2f; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); margin: 0; padding: 15px; padding-top: 60px; color: var(--text); }
        .nav-bar { position: fixed; top: 0; left: 0; right: 0; height: 50px; background: #fff; display: flex; align-items: center; justify-content: space-around; border-bottom: 1px solid #ddd; z-index: 1000; }
        .nav-item { text-decoration: none; color: #666; font-size: 0.75rem; font-weight: bold; }
        .nav-item.active { color: var(--accent); }
        .card { background: var(--card); border-radius: 12px; padding: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-bottom: 15px; }
        .label { font-size: 0.7rem; color: #888; text-transform: uppercase; font-weight: bold; display: block; margin-bottom: 5px; }
        .balance-amt { font-size: 2rem; font-weight: 800; color: var(--primary); }
        .progress-bg { background: #eee; height: 10px; border-radius: 5px; margin: 10px 0; overflow: hidden; }
        .progress-fill { background: var(--accent); height: 100%; transition: width 0.3s; }
        .input-group { display: flex; flex-direction: column; gap: 10px; margin-top: 10px; }
        input { padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 1rem; }
        .btn-main { background: var(--primary); color: white; border: none; padding: 12px; border-radius: 8px; font-weight: bold; }
        .inbox-item, .history-item { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid #eee; font-size: 0.9rem; }
        .btn-paid { background: #f0f0f0; border: none; padding: 5px 10px; border-radius: 4px; font-size: 0.75rem; font-weight: bold; }
        .status-dot {
    height: 10px; width: 10px; background-color: #bbb;
    border-radius: 50%; display: inline-block; margin-left: 10px;
}
.status-saving { background-color: #ff9800; animation: pulse 1s infinite; }
.status-success { background-color: #4caf50; }
.status-error { background-color: #f44336; }
@keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.3; } 100% { opacity: 1; } }

    </style>
</head>
<body>

    <nav class="nav-bar">
        <a href="budget.html" class="nav-item active">CONTROL</a>
        <a href="spend.html" class="nav-item">WEEKLY</a>
        <a href="projection.html" class="nav-item">PROJECTION</a>
        <a href="ledger.html" class="nav-item">LEDGER</a>
    </nav>

    <div class="card">
    <span class="label">Spendable Balance <span id="syncStatus" class="status-dot"></span></span>
    <div class="balance-amt" id="mainBalance">$0.00</div>
    <div id="savingsContainer"></div>
    <div id="amazonStatus" style="margin-top: 15px; padding-top: 10px; border-top: 1px solid #eee;"></div>
        <div class="card">
    <span class="label">Log Transaction</span>
    
    <select id="vendorSelect" onchange="toggleOtherVendor()" style="width: 100%; padding: 10px; margin-top: 5px; border-radius: 8px; border: 1px solid #ddd;">
        <option value="Amazon">Amazon</option>
        <option value="Grocery">Grocery</option>
        <option value="Gas">Gas</option>
        <option value="Dining">Dining</option>
        <option value="Income">Income/Payday</option>
        <option value="OTHER">Other...</option>
    </select>

    <input type="text" id="otherVendor" placeholder="Vendor Name" style="display:none; width: 100%; padding: 10px; margin-top: 10px; border-radius: 8px; border: 1px solid #ddd;">

    <div style="display: flex; gap: 10px; margin-top: 10px;">
        <input type="text" id="who" placeholder="Who" style="flex: 1; padding: 10px; border-radius: 8px; border: 1px solid #ddd;">
        <input type="text" id="what" placeholder="What/Note" style="flex: 2; padding: 10px; border-radius: 8px; border: 1px solid #ddd;">
    </div>

    <div style="display: flex; gap: 10px; margin-top: 10px;">
        <input type="number" id="amt" placeholder="Amount" step="0.01" style="flex: 2; padding: 10px; border-radius: 8px; border: 1px solid #ddd;">
        <button onclick="logTransaction()" class="btn btn-ok" style="flex: 1;">Add</button>
    </div>
</div>
</div>


    <div class="card">
        <span class="label">Log Purchase / Income</span>
        <div class="input-group">
            <input type="text" id="desc" placeholder="What (e.g. Kroger)">
            <input type="number" id="amt" placeholder="Amount (Spending = Negative)">
            <button class="btn-main" onclick="logTransaction()">Add Transaction</button>
        </div>
    </div>

  <div class="card">
    <span class="label">Inbox: Bills & Paydays (Next 31 Days)</span>
    <div id="inboxList"></div>
</div>
    
    <div class="card">
        <span class="label">Recent History</span>
        <div id="recentHistory"></div>
    </div>

<script>
    // [SECTION: CONFIG & DATA]
    const CONFIG = { owner: 'scottscalici', repo: 'loquesea', path: 'planner/bills.json' };
    let data = null;

    async function init() {
    // The ?t=${Date.now()} part is the magic trick. 
    // It makes every request look unique so the browser can't use a saved copy.
    const resp = await fetch(`bills.json?t=${Date.now()}`);
    data = await resp.json();
    renderUI();
}
    // [SECTION: CORE UI RENDER]
    function renderUI() {
        if (!data) return;
        document.getElementById('mainBalance').innerText = `$${data.state.checking_balance.toLocaleString(undefined, {minimumFractionDigits: 2})}`;
        
        const savDiv = document.getElementById('savingsContainer');
        savDiv.innerHTML = '';
        (data.savings_goals || []).forEach(g => {
            const pct = Math.min((g.current / g.target) * 100, 100);
            savDiv.innerHTML += `
                <div style="margin-top:10px;">
                    <div style="display:flex; justify-content:space-between; font-size:0.75rem;">
                        <span>${g.name}</span>
                        <span>$${g.current.toLocaleString()} / $${g.target.toLocaleString()}</span>
                    </div>
                    <div class="progress-bg"><div class="progress-fill" style="width:${pct}%"></div></div>
                </div>`;
        });
   function renderAmazonEscrow() {
    const amzDiv = document.getElementById('amazonStatus');
    if (!amzDiv) return;
    
    const today = new Date();
    const currentMonth = today.toISOString().slice(0, 7); 
    
    // 1. Calculate total Amazon spend this month
    const amzTotal = data.history
        .filter(h => h.date.startsWith(currentMonth) && h.vendor.toLowerCase().includes("amazon"))
        .reduce((sum, h) => sum + Math.abs(h.amount), 0);

    // 2. Determine how much of the $500 shield is left
    const shieldLimit = 500;
    const shieldRemaining = Math.max(0, shieldLimit - amzTotal);
    const overage = Math.max(0, amzTotal - shieldLimit);

    // 3. UI Colors
    let statusColor = "#2e7d32"; // Green while under $500
    if (overage > 0) statusColor = "#d32f2f"; // Red if you've eaten through the shield

    amzDiv.innerHTML = `
        <div style="margin-top: 15px; padding-top: 10px; border-top: 1px dashed #eee;">
            <span class="label">Amazon Subscription Shield ($500)</span>
            <div style="display:flex; justify-content:space-between; font-size: 0.85rem; margin-top:5px;">
                <span>Total Spent: $${amzTotal.toLocaleString()}</span>
                <span style="font-weight:bold; color:${statusColor}">
                    ${overage > 0 ? `Over Shield: $${overage.toLocaleString()}` : `Shield Left: $${shieldRemaining.toLocaleString()}`}
                </span>
            </div>
            <div style="font-size: 0.7rem; color: #666; margin-top: 4px;">
                *Subscriptions (21st-27th) use this shield first.
            </div>
        </div>
    `;
}
        renderInbox();
        renderHistory();
        renderAmazonEscrow();
    }

    // [SECTION: INBOX LOGIC]
    function renderInbox() {
        const container = document.getElementById('inboxList');
        container.innerHTML = '';
        const today = new Date();
        today.setHours(0,0,0,0);
        const todayStr = today.toISOString().split('T')[0];

        const actionLimit = new Date();
        actionLimit.setDate(today.getDate() + 31); // 31-day window as requested

        // 1. Scott's Payday
        const lastDay = new Date(today.getFullYear(), today.getMonth() + 1, 0).getDate();
        if (today.getDate() === 15 || today.getDate() === lastDay) {
            const alreadyLogged = data.history.some(h => h.date === todayStr && h.vendor === "Scott Payday");
            if (!alreadyLogged) appendInboxItem(container, "Scott Payday", 2500, 'INCOME', -1, "Due Today");
        }

        // 2. Wife's Payday
        const wifeRef = new Date("2026-01-16T12:00:00");
        const diffDays = Math.floor((today - wifeRef) / 86400000);
        if (diffDays >= 0 && diffDays % 14 === 0) {
            const alreadyLogged = data.history.some(h => h.date === todayStr && h.vendor === "Wife Payday");
            if (!alreadyLogged) appendInboxItem(container, "Wife Payday", 2500, 'INCOME', -2, "Due Today");
        }

        // 3. Bills
        const sortedBills = [...data.bills].sort((a,b) => new Date(a.next_due_date) - new Date(b.next_due_date));
        sortedBills.forEach((bill) => {
            const billDate = new Date(bill.next_due_date + "T12:00:00");
            if (billDate <= actionLimit) {
                const originalIdx = data.bills.findIndex(b => b.name === bill.name);
                appendInboxItem(container, bill.name, bill.amount, 'BILL', originalIdx, bill.next_due_date);
            }
        });
    }

    function appendInboxItem(container, name, amount, type, idx, date) {
        const div = document.createElement('div');
        div.className = 'inbox-item';
        div.innerHTML = `
            <div><b>${name}</b><br><small>${date}</small></div>
            <div>
                <span style="margin-right:10px; font-weight:bold; color:${type==='INCOME'?'green':'red'}">$${amount.toLocaleString()}</span>
                <button class="btn-paid" style="margin-right:5px;" onclick="processInboxAction(${idx}, '${type}')">OK</button>
                <button class="btn-paid" style="color:var(--danger);" onclick="skipItem(${idx}, '${type}')">SKIP</button>
            </div>`;
        container.appendChild(div);
    }

    // [SECTION: TRANSACTION LOGIC]
    async function processInboxAction(idx, type) {
        let name = (idx === -1) ? "Scott Payday" : (idx === -2) ? "Wife Payday" : data.bills[idx].name;
        let defaultAmt = (idx < 0) ? 2500 : data.bills[idx].amount;

        let userInput = prompt(`Confirm amount for ${name}:`, defaultAmt);
        if (userInput === null) return;
        let finalAmt = parseFloat(userInput);
        if (isNaN(finalAmt)) return;

        if (type === 'INCOME') data.state.checking_balance += finalAmt;
        else data.state.checking_balance -= finalAmt;

        data.history.push({
            date: new Date().toISOString().split('T')[0],
            vendor: name, what: type, amount: (type === 'BILL' ? -finalAmt : finalAmt), category: type
        });

        if (type === 'BILL' && idx >= 0) {
            advanceBillDate(idx);
        }
        await sync();
    }

        async function skipItem(idx, type) {
        let name = (idx === -1) ? "Scott Payday" : (idx === -2) ? "Wife Payday" : data.bills[idx].name;
        if (!confirm(`Skip ${name} and move to next due date?`)) return;

        console.log("Skipping:", name); // Debug line

        if (type === 'BILL' && idx >= 0) {
            advanceBillDate(idx);
            console.log("New Date set to:", data.bills[idx].next_due_date); // Debug line
        } else if (idx < 0) {
            data.history.push({
                date: new Date().toISOString().split('T')[0],
                vendor: name, what: "SKIPPED", amount: 0, category: "Skip"
            });
        }
        
        // Ensure we await the sync so the page doesn't refresh too early
        await sync();
    }

    function advanceBillDate(idx) {
        // We use T12:00:00 to avoid timezone "day-shifting" issues
        let currentStr = data.bills[idx].next_due_date;
        let d = new Date(currentStr + "T12:00:00");
        
        if (data.bills[idx].frequency === "monthly") {
            d.setMonth(d.getMonth() + 1);
        } else {
            d.setDate(d.getDate() + 14);
        }
        
        // Update the actual data object
        data.bills[idx].next_due_date = d.toISOString().split('T')[0];
    }


function toggleOtherVendor() {
    const select = document.getElementById('vendorSelect');
    const otherInput = document.getElementById('otherVendor');
    otherInput.style.display = (select.value === 'OTHER') ? 'block' : 'none';
}

async function logTransaction() {
    const select = document.getElementById('vendorSelect');
    const otherInput = document.getElementById('otherVendor');
    const who = document.getElementById('who').value;
    const what = document.getElementById('what').value;
    let amt = parseFloat(document.getElementById('amt').value);
    
    let vendor = (select.value === 'OTHER') ? otherInput.value : select.value;
    if (!vendor || isNaN(amt)) return;

    const isAmazon = vendor.toLowerCase().includes("amazon");
    const isIncome = vendor.toLowerCase().includes("income") || vendor.toLowerCase().includes("payday");

    // 1. Calculate current Amazon spend this month BEFORE this transaction
    const currentMonth = new Date().toISOString().slice(0, 7);
    const amzTotal = data.history
        .filter(h => h.date.startsWith(currentMonth) && h.vendor.toLowerCase().includes("amazon"))
        .reduce((sum, h) => sum + Math.abs(h.amount), 0);

    // 2. Main Balance Logic
    if (isIncome) {
        data.state.checking_balance += Math.abs(amt);
    } else {
        let chargeToBalance = Math.abs(amt);
        
        if (isAmazon) {
            // Apply the $500 shield logic
            const shieldRemaining = Math.max(0, 500 - amzTotal);
            // Only charge the balance for the amount that exceeds the shield
            chargeToBalance = Math.max(0, Math.abs(amt) - shieldRemaining);
        }
        
        data.state.checking_balance -= chargeToBalance;
    }

    // 3. Record in History
    data.history.push({
        date: new Date().toISOString().split('T')[0],
        vendor: vendor,
        who: who,
        what: what,
        amount: isIncome ? Math.abs(amt) : -Math.abs(amt),
        category: isAmazon ? "Amazon" : (isIncome ? "Income" : "Spending")
    });

    // Clear Inputs
    document.getElementById('amt').value = '';
    document.getElementById('who').value = '';
    document.getElementById('what').value = '';
    otherInput.value = '';
    
    await sync();
}
    
    function renderHistory() {
        const histDiv = document.getElementById('recentHistory');
        histDiv.innerHTML = '';
        data.history.slice(-5).reverse().forEach(h => {
            histDiv.innerHTML += `
                <div class="history-item">
                    <span>${h.vendor}</span>
                    <span style="color:${h.amount < 0 ? '#d32f2f' : '#2e7d32'}">${h.amount < 0 ? '' : '+'}$${h.amount.toLocaleString()}</span>
                </div>`;
        });
    }
    async function sync() {
    const status = document.getElementById('syncStatus');
    status.className = 'status-dot status-saving'; 
    
    const success = await saveToGithub(data);
    
    if (success) {
        status.className = 'status-dot status-success';
        // This is the line that handles the auto-refresh
        await init(); 
    } else {
        status.className = 'status-dot status-error';
    }
}
    
    async function saveToGithub(updatedData) {
    // 1. Get the token from storage or the hardcoded string
    const GITHUB_TOKEN = localStorage.getItem('gh_token') || "YOUR_TOKEN_HERE";
    
    try {
        // 2. Ask GitHub for the current version of the file (to get the 'sha' ID)
        const getFile = await fetch(`https://api.github.com/repos/${CONFIG.owner}/${CONFIG.repo}/contents/${CONFIG.path}`, {
            headers: { "Authorization": `token ${GITHUB_TOKEN}` }
        });
        const fileData = await getFile.json();

        // 3. Send the new data
        const response = await fetch(`https://api.github.com/repos/${CONFIG.owner}/${CONFIG.repo}/contents/${CONFIG.path}`, {
            method: "PUT",
            headers: { 
                "Authorization": `token ${GITHUB_TOKEN}`, 
                "Content-Type": "application/json" 
            },
            body: JSON.stringify({
                message: `Update via Control Center: ${new Date().toLocaleString()}`,
                // This 'unescape' trick prevents issues with emojis or special symbols
                content: btoa(unescape(encodeURIComponent(JSON.stringify(updatedData, null, 2)))),
                sha: fileData.sha
            })
        });

        return response.ok; // Returns true if it worked, false if it failed
    } catch (err) { 
        console.error("Sync Error:", err); 
        return false; 
    }
}
    

    init();
</script>

</body>
</html>
