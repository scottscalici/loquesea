<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Life Planner - Budget</title>
    <style>
        :root { --primary: #2e7d32; --bg: #f4f4f9; --card: #ffffff; --text: #333; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 20px; }
        
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .back-btn { text-decoration: none; color: #666; font-weight: bold; font-size: 1.1rem; }
        
        .card { background: var(--card); border-radius: 12px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .pacing-val { font-size: 3.5rem; font-weight: bold; color: var(--primary); text-align: center; margin: 10px 0; }
        .label { font-size: 0.75rem; color: #888; text-transform: uppercase; text-align: center; display: block; letter-spacing: 1px; }
        
        .bill-item { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid #eee; }
        .bill-item:last-child { border-bottom: none; }
        .bill-info b { display: block; font-size: 1rem; }
        .bill-info small { color: #666; }
        
        .paid-btn { background: var(--primary); color: white; border: none; padding: 10px 16px; border-radius: 8px; font-weight: bold; cursor: pointer; }
        .paid-btn:disabled { background: #ccc; }
        
        #settings { display: none; margin-bottom: 20px; border: 2px solid #ddd; }
        #settings.visible { display: block; }
        input { width: 100%; padding: 10px; margin: 10px 0; border: 1px solid #ccc; border-radius: 5px; box-sizing: border-box; }
        
        .status-msg { text-align: center; color: var(--primary); font-weight: bold; margin-bottom: 10px; }
    </style>
</head>
<body>

    <div class="header">
        <a href="index.html" class="back-btn">← Back to Life Hub</a>
        <button onclick="toggleSettings()" style="background:none; border:none; font-size: 1.5rem; cursor:pointer;">⚙️</button>
    </div>

    <div id="settings" class="card">
        <h3>Settings</h3>
        <p><small>Token is stored locally on your device only.</small></p>
        <input type="password" id="ghToken" placeholder="GitHub Personal Access Token">
        <button class="paid-btn" style="width:100%" onclick="saveToken()">Save Token</button>
    </div>

    <div id="status" class="status-msg"></div>

    <div class="card">
        <span class="label">Safe to Spend Today</span>
        <div id="pacingDisplay" class="pacing-val">--</div>
        <div style="display:flex; justify-content: space-around; margin-top: 10px;">
            <div>
                <span class="label">Weekly Left</span>
                <b id="weeklyRemaining">$0.00</b>
            </div>
            <div>
                <span class="label">Amazon Escrow</span>
                <b id="escrowDisplay">$0.00</b>
            </div>
        </div>
    </div>

    <div class="card">
        <h3>Upcoming Bills</h3>
        <div id="billList">Loading data from GitHub...</div>
    </div>

    <script>
        const CONFIG = {
            owner: 'scottscalici',
            repo: 'loquesea',
            path: 'planner/bills.json'
        };

        let budgetData = null;

        async function loadData() {
            try {
                // Fetching with a timestamp to bust cache
                const response = await fetch(`bills.json?t=${Date.now()}`);
                if (!response.ok) throw new Error("JSON file not found.");
                budgetData = await response.json();
                renderApp();
            } catch (err) {
                document.getElementById('billList').innerText = "Error: " + err.message;
            }
        }

        function renderApp() {
            const today = new Date();
            const dayOfWeek = today.getDay(); 
            const dayOfYourWeek = dayOfWeek === 0 ? 7 : dayOfWeek; 
            const daysRemaining = (7 - dayOfYourWeek) + 1;

            const pacing = (budgetData.state.current_weekly_remaining / daysRemaining).toFixed(2);
            
            document.getElementById('pacingDisplay').innerText = `$${pacing}`;
            document.getElementById('weeklyRemaining').innerText = `$${budgetData.state.current_weekly_remaining}`;
            document.getElementById('escrowDisplay').innerText = `$${budgetData.state.escrow_remaining || 0}`;
            
            renderBills();
        }

        function renderBills() {
            const list = document.getElementById('billList');
            list.innerHTML = '';
            
            const sortedBills = budgetData.bills.sort((a,b) => new Date(a.next_due_date) - new Date(b.next_due_date));

            sortedBills.forEach(bill => {
                const div = document.createElement('div');
                div.className = 'bill-item';
                div.innerHTML = `
                    <div class="bill-info">
                        <b>${bill.name}</b>
                        <small>Due: ${bill.next_due_date}</small>
                    </div>
                    <div>$${Math.abs(bill.amount)}</div>
                    <button class="paid-btn" onclick="payBill('${bill.id}')">Paid</button>
                `;
                list.appendChild(div);
            });
        }

        async function payBill(id) {
            const bill = budgetData.bills.find(b => b.id === id);
            const date = new Date(bill.next_due_date);

            // Date Jump Logic
            if (bill.excel_code === 1) date.setMonth(date.getMonth() + 1);
            else if (bill.excel_code === 14) date.setDate(date.getDate() + 14);
            else if (bill.excel_code === 12) date.setFullYear(date.getFullYear() + 1);
            else if (bill.excel_code === 3) date.setMonth(date.getMonth() + 3);
            else if (bill.excel_code === 6) date.setMonth(date.getMonth() + 6);

            bill.next_due_date = date.toISOString().split('T')[0];
            
            showStatus(`Updating ${bill.name}...`);
            await saveToGitHub();
            renderApp();
        }

        async function saveToGitHub() {
            const token = localStorage.getItem('gh_token');
            if (!token) {
                alert("Please enter your GitHub Token in Settings first!");
                toggleSettings();
                return;
            }

            try {
                // 1. Get current file SHA
                const url = `https://api.github.com/repos/${CONFIG.owner}/${CONFIG.repo}/contents/${CONFIG.path}`;
                const getFile = await fetch(url, {
                    headers: { 'Authorization': `token ${token}`, 'Cache-Control': 'no-cache' }
                });
                const fileData = await getFile.json();
                
                // 2. Push Update
                const update = await fetch(url, {
                    method: 'PUT',
                    headers: { 'Authorization': `token ${token}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        message: "Budget Update",
                        content: btoa(JSON.stringify(budgetData, null, 2)),
                        sha: fileData.sha
                    })
                });

                if (update.ok) showStatus("Changes saved to GitHub!");
                else throw new Error("GitHub Save Failed");
            } catch (err) {
                alert(err.message);
            }
        }

        function showStatus(msg) {
            const s = document.getElementById('status');
            s.innerText = msg;
            setTimeout(() => s.innerText = "", 3000);
        }

        function toggleSettings() { document.getElementById('settings').classList.toggle('visible'); }
        function saveToken() { 
            localStorage.setItem('gh_token', document.getElementById('ghToken').value); 
            toggleSettings(); 
            showStatus("Token Saved Locally");
        }

        loadData();
    </script>
</body>
</html>
