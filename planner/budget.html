<div class="card" style="background: #333; color: white;">
    <span class="label" style="color: #aaa;">Cash Flow Projections</span>
    <div class="flex-row" style="margin-top:10px; font-size: 0.9rem;">
        <div>10 Days<br><b id="proj10" style="color:#4CAF50;">$0</b></div>
        <div>30 Days<br><b id="proj30" style="color:#4CAF50;">$0</b></div>
        <div>4 Months<br><b id="proj120" style="color:#4CAF50;">$0</b></div>
    </div>
</div>

<script>
    // --- 1. MODIFIED PAY BILL (With Actual Amount) ---
    async function payBill(id) {
        const bill = data.bills.find(b => b.id === id);
        
        // Ask for actual amount (defaults to the usual amount)
        const actual = prompt(`Confirm amount for ${bill.name}:`, bill.amount);
        if (actual === null) return; // Cancel
        const finalAmt = parseFloat(actual);

        data.state.checking_balance -= finalAmt;
        
        // Standard Date Jump
        const date = new Date(bill.next_due_date);
        if (bill.frequency === "monthly") date.setMonth(date.getMonth() + 1);
        else if (bill.frequency === "bi-weekly") date.setDate(date.getDate() + 14);
        else if (bill.frequency === "annually") date.setFullYear(date.getFullYear() + 1);
        
        bill.next_due_date = date.toISOString().split('T')[0];
        data.history.push({ date: new Date().toISOString(), vendor: "BILL", what: bill.name, amount: finalAmt });
        
        await sync();
        render();
    }

    // --- 2. PROJECTION ENGINE ---
    function getProjection(days) {
        let tempBal = data.state.checking_balance;
        let tempWeekly = data.state.current_weekly_remaining;
        const targetDate = new Date();
        targetDate.setDate(targetDate.getDate() + days);

        // 1. Subtract remaining weekly budget for the first week
        tempBal -= tempWeekly;

        // 2. Simulate future weeks
        const fullWeeks = Math.floor(days / 7);
        tempBal -= (fullWeeks * 1000);

        // 3. Subtract Bills that will fall in this window
        data.bills.forEach(bill => {
            let nextDue = new Date(bill.next_due_date);
            while (nextDue <= targetDate) {
                tempBal -= bill.amount;
                // Move date forward to check for recurring hits in long windows (4 months)
                if (bill.frequency === "monthly") nextDue.setMonth(nextDue.getMonth() + 1);
                else if (bill.frequency === "bi-weekly") nextDue.setDate(nextDue.getDate() + 14);
                else break; 
            }
        });

        // 4. Add Paydays that will fall in this window
        (data.paydays || []).forEach(pay => {
            let nextPay = new Date(pay.next_date);
            while (nextPay <= targetDate) {
                tempBal += pay.amount;
                if (pay.frequency === "bi-weekly") nextPay.setDate(nextPay.getDate() + 14);
                else if (pay.frequency === "monthly") nextPay.setMonth(nextPay.getMonth() + 1);
                else break;
            }
        });

        return tempBal.toLocaleString(undefined, {minimumFractionDigits: 0, maximumFractionDigits: 0});
    }

    // Update render function to include projections
    function render() {
        // ... (existing pacing and history code) ...
        document.getElementById('proj10').innerText = `$${getProjection(10)}`;
        document.getElementById('proj30').innerText = `$${getProjection(30)}`;
        document.getElementById('proj120').innerText = `$${getProjection(120)}`;
    }
</script>
