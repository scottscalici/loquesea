<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Lego Dashboard 2026</title>
    <style>
        :root {
            --bg: #121212;
            --brick-blue: #3498db;
            --brick-purple: #9b59b6;
            --brick-orange: #e67e22;
            --text: #ffffff;
        }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); padding: 20px; }
        .container { max-width: 800px; margin: auto; }
        .nav-bar { display: flex; gap: 10px; align-items: center; background: #222; padding: 15px; border-radius: 8px; margin-bottom: 20px; }
        #timeline { position: relative; width: 100%; border-left: 2px solid #333; margin-top: 20px; }
        #all-day-container { display: flex; flex-direction: column; gap: 8px; margin-bottom: 12px; }
        .all-day-brick { background: #555; border-left: 8px solid #e67e22; border-radius: 8px; padding: 10px; font-size: 0.9em; box-shadow: 0 4px 6px rgba(0,0,0,0.3); }
        .brick { position: absolute; width: calc(100% - 40px); margin-left: 20px; border-radius: 8px; padding: 10px; border-left: 8px solid rgba(0,0,0,0.3); box-sizing: border-box; font-size: 0.9em; box-shadow: 0 4px 6px rgba(0,0,0,0.3); }
        .blue { background: var(--brick-blue); }
        .purple { background: var(--brick-purple); }
        .orange { background: var(--brick-orange); }
        #time-marker { position: absolute; width: 100%; border-top: 2px solid red; z-index: 100; pointer-events: none; }
    </style>
</head>
<body>

<div class="container">
    <div class="nav-bar">
        <label for="date-picker">Navigate:</label>
        <input type="date" id="date-picker">
        <button onclick="changeDay(-1)">â—€ Prev</button>
        <button onclick="changeDay(1)">Next â–¶</button>
        <button onclick="goToToday()">Today</button>
    </div>
    <h2 id="day-header">Loading Schedule...</h2>
    <div id="all-day-container"></div>
    <div id="timeline"></div>
</div>

<script>
    const CONFIG = {
        scheduleUrl: 'https://raw.githubusercontent.com/scottscalici/loquesea/main/planner/schedule.json',
        calendarUrl: 'https://raw.githubusercontent.com/scottscalici/imagenes/main/planes/calendario.json',
        coziUrl: 'https://rest.cozi.com/api/ext/1103/f9f7020d-05c9-4720-b813-2155b4485be7/icalendar/feed/feed.ics',
        proxy: 'https://corsproxy.io/?',
        pixelsPerMinute: 1.5, 
        dayStartHour: 5 
    };

    let currentSelectedDate = new Date();

    // --- 1. CORE RENDERING ENGINE ---
    function renderBrick(start, end, title, colorClass) {
        const timeline = document.getElementById('timeline');
        const brick = document.createElement('div');
        const [hS, mS] = start.split(':').map(Number);
        const [hE, mE] = end.split(':').map(Number);
        const startMins = (hS - CONFIG.dayStartHour) * 60 + mS;
        const durationMins = (hE * 60 + mE) - (hS * 60 + mS);
        brick.className = `brick ${colorClass}`;
        brick.style.top = `${startMins * CONFIG.pixelsPerMinute}px`;
        brick.style.height = `${durationMins * CONFIG.pixelsPerMinute}px`;
        brick.innerHTML = `<strong>${start} - ${end}</strong><br>${title}`;
        timeline.appendChild(brick);
    }

    function renderAllDayBrick(title) {
        const container = document.getElementById('all-day-container');
        const div = document.createElement('div');
        div.className = 'all-day-brick';
        div.innerHTML = `<strong>All Day</strong><br>${title}`;
        container.appendChild(div);
    }

    // --- 2. SCHOOL CYCLE MODULE ---
    async function syncSchoolCycle(todayStr) {
        try {
            const [calRes, schedRes] = await Promise.all([
                fetch(CONFIG.calendarUrl),
                fetch(CONFIG.scheduleUrl)
            ]);
            const calData = await calRes.json();
            const schedule = await schedRes.json();
            const dayInfo = calData.map?.find(d => d.fecha === todayStr);
            const cycle = dayInfo?.ciclo; 
            const dayNum = currentSelectedDate.getDay();
            if (dayNum === 0 || dayNum === 6) return; 

            if (schedule.hard_stops?.school_dropoff) {
                const dropoff = schedule.hard_stops.school_dropoff;
                const routine = schedule.definitions.routines[dropoff.trigger_routine];
                const wheelsUp = subtractMinutes(dropoff.time, dropoff.commute_minutes);
                const wakeUp = subtractMinutes(wheelsUp, routine.duration);
                renderBrick(wakeUp, wheelsUp, `ðŸš€ ${routine.label}`, "purple");
            }

            const dayKey = cycle === "A" ? "A_Day" : (cycle === "B" ? "B_Day" : null);
            if (dayKey && schedule.days[dayKey]) {
                schedule.days[dayKey].forEach(brick => {
                    const temp = schedule.definitions.brick_templates[brick.template];
                    const endTime = brick.end || addMinutes(brick.start, brick.duration || 60);
                    renderBrick(brick.start, endTime, brick.label, temp?.color || "blue");
                });
            }
        } catch (e) { console.error("School Cycle Error:", e); }
    }

    // --- 3. COZI MODULE ---
    async function syncCozi(todayMatch, dow) {
        try {
            const res = await fetch(CONFIG.proxy + encodeURIComponent(CONFIG.coziUrl));
            const text = (await res.text()).replace(/\r\n /g, "");
            const vevents = text.split("BEGIN:VEVENT");
            let takenTimes = new Set();

            const getStartDate = (b) => { const m = b.match(/DTSTART.*:(\d{8})/); return m ? m[1] : null; };
            const getStartTime = (b) => { const m = b.match(/DTSTART[:;](?:.*T)?(\d{2})(\d{2})/); return m ? `${m[1]}:${m[2]}` : null; };
            const parseRRule = (r) => { const obj = {}; r.split(";").forEach(p => { const [k, v] = p.split("="); obj[k] = v; }); return obj; };
            const isExcluded = (b, t) => { const matches = [...b.matchAll(/EXDATE[^:]*:(\d{8})/g)]; return matches.some(m => m[1] === t); };

            const occursToday = (block, today, dayOfWeek) => {
                const startDate = getStartDate(block);
                if (!startDate || isExcluded(block, today)) return false;
                const rruleMatch = block.match(/RRULE:(.*)/);
                if (!rruleMatch) return startDate === today;
                const rrule = parseRRule(rruleMatch[1]);
                if (rrule.UNTIL && rrule.UNTIL.slice(0, 8) < today) return false;
                if (startDate > today) return false;
                switch (rrule.FREQ) {
                    case "DAILY": return true;
                    case "WEEKLY": return rrule.BYDAY ? rrule.BYDAY.includes(dayOfWeek) : false;
                    case "YEARLY": return today.slice(4) === startDate.slice(4);
                    default: return false;
                }
            };

            vevents.forEach(block => {
                if (!occursToday(block, todayMatch, dow)) return;
                const summary = block.match(/SUMMARY:(.*)/)?.[1]?.trim() || "Event";
                const startTime = getStartTime(block);
                if (!startTime) { renderAllDayBrick(`ðŸ  ${summary}`); return; }
                const key = startTime + summary;
                if (!takenTimes.has(key)) {
                    renderBrick(startTime, addMinutes(startTime, 90), `ðŸ  ${summary}`, "orange");
                    takenTimes.add(key);
                }
            });
        } catch (e) { console.error("Cozi Error:", e); }
    }

    // --- 4. THE CONDUCTOR ---
    async function updateUI() {
        const todayStr = currentSelectedDate.toLocaleDateString('sv');
        const todayMatch = todayStr.replace(/-/g, '');
        const daysMap = ['SU', 'MO', 'TU', 'WE', 'TH', 'FR', 'SA'];
        const currentDayOfWeek = daysMap[currentSelectedDate.getDay()];
        const timeline = document.getElementById('timeline');
        timeline.innerHTML = '';
        timeline.style.height = `${(22 - CONFIG.dayStartHour) * 60 * CONFIG.pixelsPerMinute}px`;
        document.getElementById('all-day-container').innerHTML = '';
        document.getElementById('date-picker').value = todayStr;
        document.getElementById('day-header').innerText = `Schedule for ${todayStr} (${currentDayOfWeek})`;
        await syncSchoolCycle(todayStr);
        await syncCozi(todayMatch, currentDayOfWeek);
        renderRedLine();
    }

    // --- HELPERS ---
    function changeDay(offset) { currentSelectedDate.setDate(currentSelectedDate.getDate() + offset); updateUI(); }
    function goToToday() { currentSelectedDate = new Date(); updateUI(); }
    function addMinutes(t, m) { const [h, min] = t.split(':').map(Number); const d = new Date(); d.setHours(h, min + m); return d.toTimeString().slice(0, 5); }
    function subtractMinutes(t, m) { const [h, min] = t.split(':').map(Number); const d = new Date(); d.setHours(h, min - m); return d.toTimeString().slice(0, 5); }

    function renderRedLine() {
        const now = new Date();
        if (now.toLocaleDateString('sv') !== currentSelectedDate.toLocaleDateString('sv')) return;
        const elapsed = (now.getHours() - CONFIG.dayStartHour) * 60 + now.getMinutes();
        let marker = document.getElementById('time-marker') || document.createElement('div');
        marker.id = 'time-marker';
        document.getElementById('timeline').appendChild(marker);
        marker.style.top = `${elapsed * CONFIG.pixelsPerMinute}px`;
    }

    document.getElementById('date-picker').addEventListener('change', (e) => {
        currentSelectedDate = new Date(e.target.value + "T12:00:00");
        updateUI();
    });

    updateUI();
    setInterval(renderRedLine, 60000);
</script>
</body>
</html>
