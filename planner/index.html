<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Lego Dashboard</title>
    <style>
        :root { --brick-gap: 10px; }
        body { font-family: 'Segoe UI', sans-serif; background: #1a1a1a; color: white; padding: 20px; }
        .timeline { display: flex; flex-direction: column; gap: var(--brick-gap); max-width: 600px; margin: auto; }
        
        /* Real Lego Bricks */
        .brick { background: #3498db; border-radius: 8px; padding: 15px; position: relative; border-left: 10px solid #2980b9; }
        .brick.meeting-nested { background: #9b59b6; border-left-color: #8e44ad; }
        
        /* Ghost Blocks for Gaps */
        .ghost-brick { border: 2px dashed #444; border-radius: 8px; padding: 15px; text-align: center; cursor: pointer; color: #666; transition: 0.3s; }
        .ghost-brick:hover { border-color: #3498db; color: #3498db; background: rgba(52, 152, 219, 0.1); }

        .nested-event { background: rgba(255,255,255,0.2); margin-top: 10px; padding: 5px; border-radius: 4px; font-size: 0.85em; }
        .config-bar { background: #333; padding: 10px; margin-bottom: 20px; border-radius: 8px; }
    </style>
</head>
<body>

<div class="config-bar">
    <input type="password" id="cal-token" placeholder="Paste Calendly Token">
    <button onclick="refreshDashboard()">Sync Dashboard</button>
</div>

<div class="timeline" id="dashboard">
    </div>

<script>
    // Example Block Schedule (This will eventually come from your house.json)
    let dailyBlocks = [
        { name: "Morning Routine", start: "07:00", end: "09:00" },
        { name: "Deep Work", start: "09:00", end: "12:00" },
        { name: "Admin/Prep", start: "13:00", end: "15:00" }
    ];

    async function fetchCalendlyMeetings(token) {
        if (!token) return [];
        try {
            const response = await fetch('https://api.calendly.com/scheduled_events?user=https://api.calendly.com/users/me', {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            const data = await response.json();
            return data.collection || [];
        } catch (e) { console.error("Calendly error", e); return []; }
    }

    async function refreshDashboard() {
        const token = document.getElementById('cal-token').value;
        const meetings = await fetchCalendlyMeetings(token);
        renderDashboard(meetings);
    }

    function renderDashboard(meetings) {
        const container = document.getElementById('dashboard');
        container.innerHTML = "";

        // Sort blocks by time
        dailyBlocks.sort((a,b) => a.start.localeCompare(b.start));

        dailyBlocks.forEach((block, index) => {
            // 1. Check for Gaps (Ghost Blocks) before this block
            if (index > 0) {
                const prevEnd = dailyBlocks[index-1].end;
                if (prevEnd < block.start) {
                    container.appendChild(createGhostBlock(prevEnd, block.start));
                }
            }

            // 2. Create the Real Brick
            const brick = document.createElement('div');
            brick.className = 'brick';
            brick.innerHTML = `<strong>${block.name}</strong> <small>(${block.start} - ${block.end})</small>`;

            // 3. Nest Calendly Meetings
            meetings.forEach(m => {
                const mStart = new Date(m.start_time).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit', hour12: false});
                if (mStart >= block.start && mStart < block.end) {
                    brick.classList.add('meeting-nested');
                    brick.innerHTML += `<div class="nested-event">ðŸ“… ${m.name} at ${mStart}</div>`;
                }
            });

            container.appendChild(brick);
        });
    }

    function createGhostBlock(start, end) {
        const ghost = document.createElement('div');
        ghost.className = 'ghost-brick';
        ghost.innerHTML = `+ Add Task (${start} - ${end})`;
        ghost.onclick = () => {
            const taskName = prompt(`What are we doing between ${start} and ${end}?`);
            if (taskName) {
                dailyBlocks.push({ name: taskName, start, end });
                renderDashboard([]);
            }
        };
        return ghost;
    }

    renderDashboard([]);
</script>
</body>
</html>
