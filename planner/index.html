<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Lego Dashboard & House Hub</title>
    <style>
        :root {
            --bg: #121212;
            --brick-blue: #3498db;
            --brick-purple: #9b59b6;
            --ghost-border: #444;
            --text: #ffffff;
        }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); padding: 20px; }
        .container { max-width: 800px; margin: auto; }
        
        .config-bar { background: #222; padding: 15px; border-radius: 10px; margin-bottom: 30px; display: flex; flex-wrap: wrap; gap: 10px; }
        input { background: #fff; color: #000; border: 1px solid #555; padding: 10px; border-radius: 5px; flex: 1; min-width: 200px; }
        button { cursor: pointer; padding: 10px 15px; border-radius: 5px; border: none; font-weight: bold; }
        .btn-uri { background: #f1c40f; color: black; }
        .btn-sync { background: var(--brick-blue); color: white; }
        
        .timeline { display: flex; flex-direction: column; gap: 12px; }
        .brick { background: var(--brick-blue); border-radius: 8px; padding: 20px; border-left: 12px solid rgba(0,0,0,0.3); position: relative; }
        .brick.meeting-nested { background: var(--brick-purple); }
        
        .ghost-brick { border: 2px dashed var(--ghost-border); border-radius: 8px; padding: 15px; text-align: center; cursor: pointer; color: #888; }
        .ghost-brick:hover { border-color: var(--brick-blue); color: var(--brick-blue); background: rgba(52, 152, 219, 0.05); }

        .nested-event { background: rgba(0,0,0,0.2); margin-top: 10px; padding: 10px; border-radius: 6px; font-size: 0.9em; border-left: 3px solid #fff; }
        .time-label { font-size: 0.8em; opacity: 0.7; display: block; }
    </style>
</head>
<body>

<div class="container">
    <div class="config-bar">
        <input type="text" id="cal-token" placeholder="1. Paste Token Here">
        <input type="text" id="user-uri" placeholder="2. User URI will appear here">
        <button class="btn-uri" onclick="findMyUri()">Step 1: Get URI</button>
        <button class="btn-sync" onclick="refreshDashboard()">Step 2: Sync Dashboard</button>
    </div>
    <div class="config-bar" style="background: #333; justify-content: center;">
    <label for="date-select">ðŸ“… View Date: </label>
    <input type="date" id="date-select" onchange="ScheduleManager.changeDate(this.value)">
    <button onclick="ScheduleManager.init()" style="background: #555; color: white;">Reset to Today</button>
</div>

<div id="status-header" style="text-align: center; margin-bottom: 20px;">
    <h2 id="current-day-display">Loading Schedule...</h2>
    <p id="day-note" style="color: #f1c40f; font-weight: bold;"></p>
</div>

    <div id="dashboard" class="timeline"></div>
</div>
<script>
/**
 * SECTION: DATA & CONFIG
 */
let scheduleState = {
    currentCycle: null,
    note: "",
    dailyBlocks: [],
    meetings: []
};

// ... keep your 'templates' object here ...

/**
 * SECTION: THE FIX - Independent Init
 */
const ScheduleManager = {
    jsonUrl: "https://raw.githubusercontent.com/scottscalici/imagenes/refs/heads/main/planes/calendario.json",
    
    init: async () => {
        // 1. Force the UI to show the Base Bricks immediately
        scheduleState.dailyBlocks = [...templates.base];
        UIRenderer.render();

        // 2. Try to fetch the A/B cycle from your GitHub JSON
        try {
            const response = await fetch(ScheduleManager.jsonUrl);
            const data = await response.json();
            const today = new Date().toISOString().split('T')[0];
            const dayInfo = data.map.find(item => item.fecha === today);

            if (dayInfo) {
                scheduleState.currentCycle = dayInfo.ciclo;
                scheduleState.note = dayInfo.note || "";
                
                // Add the Cycle blocks to the base blocks
                let cycleBlocks = (dayInfo.ciclo === "A") ? templates.cicloA : templates.cicloB;
                scheduleState.dailyBlocks = [...templates.base, ...(cycleBlocks || [])];
            }
            // Update UI with the new A/B data
            UIRenderer.render();
        } catch (e) {
            console.warn("Could not load A/B cycle, staying on Base blocks.");
        }
    }
};

/**
 * SECTION: CALENDLY SYNC (Step 1 & 2)
 */
async function findMyUri() {
    const token = document.getElementById('cal-token').value.trim();
    if (!token) return alert("Please paste the token first!");
    
    const PROXY = "https://corsproxy.io/?";
    const target = "https://api.calendly.com/users/me";

    try {
        const res = await fetch(PROXY + encodeURIComponent(target), {
            headers: { 'Authorization': `Bearer ${token}`, 'Accept': 'application/json' }
        });
        const data = await res.json();
        if (data.resource) {
            document.getElementById('user-uri').value = data.resource.uri;
            alert("Success! URI Found. Now click Sync Dashboard.");
        } else {
            alert("Token accepted, but Calendly didn't return a User URI. Check token permissions.");
        }
    } catch (e) {
        alert("Network error. The proxy might be down or the token is invalid.");
    }
}

// Kick off the app
ScheduleManager.init();


</script>
</body>
</html>
