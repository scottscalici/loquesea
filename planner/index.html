<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Lego Dashboard 2026</title>
    <style>
        :root {
            --bg: #121212;
            --brick-blue: #3498db;
            --brick-purple: #9b59b6;
            --brick-orange: #e67e22;
            --text: #ffffff;
        }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); padding: 20px; }
        .container { max-width: 800px; margin: auto; }
        .nav-bar { display: flex; gap: 10px; align-items: center; background: #222; padding: 15px; border-radius: 8px; margin-bottom: 20px; }
        
        #timeline { position: relative; width: 100%; border-left: 2px solid #333; margin-top: 20px; min-height: 1200px; }
        #all-day-container { display: flex; flex-direction: column; gap: 8px; margin-bottom: 12px; }
        
        .all-day-brick { background: #555; border-left: 8px solid #e67e22; border-radius: 8px; padding: 10px; font-size: 0.9em; box-shadow: 0 4px 6px rgba(0,0,0,0.3); }
        .brick { position: absolute; width: calc(100% - 40px); margin-left: 20px; border-radius: 8px; padding: 10px; border-left: 8px solid rgba(0,0,0,0.3); box-sizing: border-box; font-size: 0.9em; box-shadow: 0 4px 6px rgba(0,0,0,0.3); cursor: pointer; transition: transform 0.1s; }
        .brick:active { transform: scale(0.98); }

        /* Roles/Colors */
        .blue { background: var(--brick-blue); }
        .purple { background: var(--brick-purple); }
        .orange { background: var(--brick-orange); }
        .teaching { background: #e74c3c; border-left-color: #c0392b; }
        .prep { background: #3498db; border-left-color: #21618c; }
        .lunch { background: #000000; opacity: 0.85; }
        .blue-meeting { background: #2980b9 !important; border: 2px solid #ffffff; z-index: 10; font-weight: bold; }

        /* Time Marker */
        #time-marker { position: absolute; width: 100%; border-top: 2px solid #ff4757; z-index: 100; pointer-events: none; }
        #time-marker::after { content: '‚óè'; color: #ff4757; position: absolute; left: -10px; top: -9px; font-size: 18px; }

        /* Popover */
        .brick-popover { position: absolute; background: #1f1f1f; border: 1px solid #333; border-radius: 8px; padding: 10px; width: 220px; z-index: 1000; box-shadow: 0 10px 25px rgba(0,0,0,0.4); }
        .hidden { display: none; }
        .popover-title { font-weight: bold; margin-bottom: 8px; font-size: 14px; color: #fff; }
        .popover-btn { width: 100%; background: #2a2a2a; color: white; border: none; padding: 8px; margin-top: 6px; border-radius: 6px; cursor: pointer; text-align: left; }
        .popover-btn:hover { background: #3a3a3a; }
        .popover-btn.danger { background: #402020; }

        /* Tasks */
        .task-list { margin-top: 8px; padding-left: 0; list-style: none; font-size: 0.85em; }
        .task-item { display: flex; align-items: center; gap: 8px; margin-bottom: 4px; }
    </style>
</head>
<body>

<div class="container">
    <div class="nav-bar">
        <label for="date-picker">Navigate:</label>
        <input type="date" id="date-picker">
        <button onclick="changeDay(-1)">‚óÄ Prev</button>
        <button onclick="changeDay(1)">Next ‚ñ∂</button>
        <button onclick="goToToday()">Today</button>
    </div>
    
    <h2 id="day-header">Loading Schedule...</h2>
    <div id="all-day-container"></div>
    <div id="timeline"></div>
</div>

<div id="brick-popover" class="brick-popover hidden">
    <div class="popover-title" id="popover-title">Block Title</div>
    <button class="popover-btn" data-action="travel">‚ûï Add travel before</button>
    <button class="popover-btn" data-action="checklist">‚òëÔ∏è Add checklist</button>
    <button class="popover-btn danger" data-action="delete">üóë Delete</button>
</div>

<script>
/* =========================
   GLOBAL CONFIG
========================= */
const CONFIG = {
    scheduleUrl: 'https://raw.githubusercontent.com/scottscalici/loquesea/main/planner/schedule.json',
    calendarUrl: 'https://raw.githubusercontent.com/scottscalici/imagenes/main/planes/calendario.json',
    placesUrl: 'https://raw.githubusercontent.com/scottscalici/loquesea/main/planner/places.json',
    coziUrl: 'https://rest.cozi.com/api/ext/1103/f9f7020d-05c9-4720-b813-2155b4485be7/icalendar/feed/feed.ics',
    calendlyToken: 'eyJraWQiOiIxY2UxZTEzNjE3ZGNmNzY2YjNjZWJjY2Y4ZGM1YmFmYThhNjVlNjg0MDIzZjdjMzJiZTgzNDliMjM4MDEzNWI0IiwidHlwIjoiUEFUIiwiYWxnIjoiRVMyNTYifQ.eyJpc3MiOiJodHRwczovL2F1dGguY2FsZW5kbHkuY29tIiwiaWF0IjoxNzY5MjMzNzU5LCJqdGkiOiJlODY1MTVlYS1hOGRiLTQ5YjMtYmI5Ny1lOWU5ZWIzYTI1NmQiLCJ1c2VyX3V1aWQiOiIzMGZkMzdhYS1kMGUyLTQxODYtOTVkNi04MjU2NTYxMDczMWIifQ.lF3v1MUuFxrttIsaDu5yNCWI0UTN9Z7NvQI78IPyxnR3D5scFL7iCIyormTQdu9_GHp_pnnTJ5lGPiXtGKLWtg',
    proxy: 'https://corsproxy.io/?',
    pixelsPerMinute: 1.5,
    dayStartHour: 5
};

const TEMPLATE_ROLE_MAP = { class: "teaching", prep: "prep", routine: "lunch", work: "prep" };
let renderedBricks = [];
let PLACES = {};
let currentSelectedDate = new Date();
let activeBrickData = null;

const popover = document.getElementById("brick-popover");
const popoverTitle = document.getElementById("popover-title");

/* =========================
   HELPERS
========================= */
function addMinutes(t, m) {
    const [h, min] = t.split(':').map(Number);
    const d = new Date(); d.setHours(h, min + m);
    return d.toTimeString().slice(0, 5);
}

function localDayToUTCWindow(dateStr) {
    return { min: new Date(dateStr + "T00:00:00").toISOString(), max: new Date(dateStr + "T23:59:59").toISOString() };
}

function format12Hour(timeStr) {
    if (!timeStr) return "";
    let [h, m] = timeStr.split(':').map(Number);
    const ampm = h >= 12 ? 'PM' : 'AM';
    h = h % 12 || 12;
    return `${h}:${m.toString().padStart(2, '0')} ${ampm}`;
}

/* =========================
   CORE RENDERING
========================= */
function renderBrick(start, end, title, colorClass, tasks = [], meta = {}) {
    const timeline = document.getElementById('timeline');
    const brickEl = document.createElement('div');

    const [hS, mS] = start.split(':').map(Number);
    const [hE, mE] = end.split(':').map(Number);
    const startAbs = hS * 60 + mS;
    const endAbs = hE * 60 + mE;

    brickEl.className = `brick ${colorClass}`;
    brickEl.style.top = `${(startAbs - CONFIG.dayStartHour * 60) * CONFIG.pixelsPerMinute}px`;
    brickEl.style.height = `${(endAbs - startAbs) * CONFIG.pixelsPerMinute}px`;

    let html = `<strong>${format12Hour(start)} ‚Äì ${format12Hour(end)}</strong><br>${title}`;
    if (tasks.length) {
        html += `<ul class="task-list">` + tasks.map(t => `<li class="task-item"><input type="checkbox"> ${t}</li>`).join('') + `</ul>`;
    }
    brickEl.innerHTML = html;

    // Click for Popover
    brickEl.addEventListener("click", (e) => {
        e.stopPropagation();
        showBrickPopover({start, end, title, meta}, brickEl);
    });

    timeline.appendChild(brickEl);
    renderedBricks.push({ el: brickEl, start: startAbs, end: endAbs, meta: meta });
}

function renderAllDayBrick(title) {
    const container = document.getElementById('all-day-container');
    const div = document.createElement('div');
    div.className = 'all-day-brick';
    div.innerHTML = `<strong>All Day</strong><br>${title}`;
    container.appendChild(div);
}

/* =========================
   POPOVER LOGIC
========================= */
function showBrickPopover(data, el) {
    activeBrickData = data;
    popoverTitle.textContent = data.title;
    const rect = el.getBoundingClientRect();
    popover.style.top = `${window.scrollY + rect.top}px`;
    popover.style.left = `${window.scrollX + rect.right + 10}px`;
    popover.classList.remove("hidden");
}

document.addEventListener("click", () => popover.classList.add("hidden"));
popover.addEventListener("click", (e) => {
    e.stopPropagation();
    const action = e.target.dataset.action;
    if (action) alert(`Action: ${action} on ${activeBrickData.title}`);
});

/* =========================
   DATA SYNC
========================= */
async function syncSchoolCycle(todayStr) {
    try {
        if ([0, 6].includes(currentSelectedDate.getDay())) return;
        const [calRes, schedRes] = await Promise.all([fetch(CONFIG.calendarUrl), fetch(CONFIG.scheduleUrl)]);
        const calData = await calRes.json();
        const schedule = await schedRes.json();
        const dayInfo = calData.map?.find(d => d.fecha === todayStr);
        const cycle = dayInfo?.ciclo;
        const dayKey = cycle === "A" ? "A_Day" : cycle === "B" ? "B_Day" : null;
        if (!dayKey) return;

        schedule.days[dayKey].forEach(b => {
            const endTime = b.end || addMinutes(b.start, b.duration || 60);
            renderBrick(b.start, endTime, b.label, TEMPLATE_ROLE_MAP[b.template] || "teaching", b.tasks || []);
        });
    } catch (e) { console.error("School Error", e); }
}

/* =========================
   COZI CALENDAR
========================= */

async function syncCozi(todayMatch, dow) {
    try {
        const res = await fetch(CONFIG.proxy + encodeURIComponent(CONFIG.coziUrl));
        let text = (await res.text()).replace(/\r\n /g, "");

        const vevents = text.split("BEGIN:VEVENT");

        function parseRRule(rr) {
            const o = {};
            rr.split(";").forEach(p => {
                const [k, v] = p.split("=");
                o[k] = v;
            });
            return o;
        }

        function isExcluded(block) {
    const exDates = [...block.matchAll(/EXDATE[^:]*:(\d{8})/g)]
        .map(m => m[1]);
    return exDates.includes(todayMatch);
}

        function occursToday(block) {
    if (isExcluded(block)) return false;

    const startMatch = block.match(/DTSTART.*:(\d{8})/);
    if (!startMatch) return false;

    const startDate = startMatch[1];
    const rruleMatch = block.match(/RRULE:(.*)/);

    if (!rruleMatch) return startDate === todayMatch;

            const r = parseRRule(rruleMatch[1]);
            if (r.UNTIL && r.UNTIL.slice(0, 8) < todayMatch) return false;

            if (r.FREQ === "DAILY") return todayMatch >= startDate;
            if (r.FREQ === "WEEKLY" && r.BYDAY?.includes(dow)) return todayMatch >= startDate;

            return false;
        }

        function getEnd(block, start) {
            const dtEnd = block.match(/DTEND[:;](?:.*T)?(\d{2})(\d{2})/);
            if (dtEnd) return `${dtEnd[1]}:${dtEnd[2]}`;

            const dur = block.match(/DURATION:PT(?:(\d+)H)?(?:(\d+)M)?/);
            if (dur) {
                const mins = (parseInt(dur[1] || 0) * 60) + parseInt(dur[2] || 0);
                return addMinutes(start, mins);
            }

            return addMinutes(start, 60);
        }

        vevents.forEach(block => {
            const summaryMatch = block.match(/SUMMARY:(.*)/);
            if (!summaryMatch) return;

            const summary = summaryMatch[1].trim();
            const dateRange = block.match(/DTSTART.*:(\d{8}).*DTEND.*:(\d{8})/);

            if (dateRange) {
                if (todayMatch >= dateRange[1] && todayMatch < dateRange[2]) {
                    renderAllDayBrick(`üè† ${summary}`);
                }
                return;
            }

            if (!occursToday(block)) return;

            const timeMatch = block.match(/DTSTART[:;](?:.*T)?(\d{2})(\d{2})/);
            if (!timeMatch) {
                renderAllDayBrick(`üè† ${summary}`);
                return;
            }

            const start = `${timeMatch[1]}:${timeMatch[2]}`;
            const end = getEnd(block, start);
            renderBrick(start, end, `üè† ${summary}`, "orange");
        });

    } catch (e) {
        console.error("Cozi error", e);
    }
}

async function syncCalendly(todayStr) {
    if (!CONFIG.calendlyToken || CONFIG.calendlyToken.includes('PASTE')) return;
    try {
        const userRes = await fetch(CONFIG.proxy + encodeURIComponent('https://api.calendly.com/users/me'), { 
            headers: { Authorization: `Bearer ${CONFIG.calendlyToken}` } 
        });
        const userData = await userRes.json();
        const { min, max } = localDayToUTCWindow(todayStr);
        const eventsRes = await fetch(CONFIG.proxy + encodeURIComponent(`https://api.calendly.com/scheduled_events?user=${userData.resource.uri}&min_start_time=${min}&max_start_time=${max}`), { 
            headers: { Authorization: `Bearer ${CONFIG.calendlyToken}` } 
        });
        const eventsData = await eventsRes.json();
        eventsData.collection.forEach(ev => {
            if (ev.status !== "active") return;
            const start = new Date(ev.start_time);
            const sTime = start.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' });
            const eTime = new Date(ev.end_time).toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' });
            renderBrick(sTime, eTime, `üìÖ ${ev.name}`, "blue-meeting", [], { nest: true });
        });
    } catch (e) { console.error("Calendly Error", e); }
}

/* =========================
   LAYOUT ENGINES
========================= */
function nestCalendlyMeetings() {
    const preps = renderedBricks.filter(b => b.el.classList.contains('prep'));
    renderedBricks.filter(b => b.meta?.nest).forEach(meeting => {
        const parent = preps.find(p => meeting.start >= p.start && meeting.end <= p.end);
        if (!parent) return;
        meeting.el.style.top = `${(meeting.start - parent.start) * CONFIG.pixelsPerMinute}px`;
        meeting.el.style.left = '8px';
        meeting.el.style.width = 'calc(100% - 16px)';
        parent.el.appendChild(meeting.el);
        meeting.nested = true;
    });
}

function stackOverlappingBricks() {
    const stackable = renderedBricks.filter(b => !b.nested).sort((a,b) => a.start - b.start);
    stackable.forEach(b => {
        b.el.style.width = 'calc(100% - 40px)';
        b.el.style.left = '20px';
    });
}

/* =========================
   UI CONTROL
========================= */
async function updateUI() {
    const todayStr = currentSelectedDate.toLocaleDateString('sv');
    const todayMatch = todayStr.replace(/-/g, '');
    const dow = ['SU','MO','TU','WE','TH','FR','SA'][currentSelectedDate.getDay()];

    document.getElementById('timeline').innerHTML = '';
    document.getElementById('all-day-container').innerHTML = '';
    document.getElementById('date-picker').value = todayStr;
    document.getElementById('day-header').innerText = `Schedule for ${todayStr} (${dow})`;

    renderedBricks = [];
    await syncSchoolCycle(todayStr);
    await syncCozi(todayMatch, dow);
    await syncCalendly(todayStr);

    nestCalendlyMeetings();
    stackOverlappingBricks();
    renderRedLine();
}

function renderRedLine() {
    const now = new Date();
    if (now.toDateString() !== currentSelectedDate.toDateString()) return;
    const elapsed = (now.getHours() - CONFIG.dayStartHour) * 60 + now.getMinutes();
    if (elapsed < 0) return;
    let line = document.getElementById('time-marker') || document.createElement('div');
    line.id = 'time-marker';
    line.style.top = `${elapsed * CONFIG.pixelsPerMinute}px`;
    document.getElementById('timeline').appendChild(line);
}

function changeDay(offset) { currentSelectedDate.setDate(currentSelectedDate.getDate() + offset); updateUI(); }
function goToToday() { currentSelectedDate = new Date(); updateUI(); }

document.getElementById('date-picker').addEventListener('change', e => {
    currentSelectedDate = new Date(e.target.value + "T12:00");
    updateUI();
});

updateUI();
setInterval(renderRedLine, 60000);
</script>
</body>
</html>
