<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Lego Dashboard & House Hub</title>
    <style>
        :root {
            --bg: #121212;
            --brick-blue: #3498db;
            --brick-purple: #9b59b6;
            --ghost-border: #444;
            --text: #ffffff;
        }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); padding: 20px; }
        .container { max-width: 800px; margin: auto; }
        .config-bar { background: #222; padding: 15px; border-radius: 10px; margin-bottom: 30px; display: flex; flex-wrap: wrap; gap: 10px; }
        input { background: #fff; color: #000; border: 1px solid #555; padding: 10px; border-radius: 5px; flex: 1; min-width: 200px; }
        button { cursor: pointer; padding: 10px 15px; border-radius: 5px; border: none; font-weight: bold; }
        .btn-uri { background: #f1c40f; color: black; }
        .btn-sync { background: var(--brick-blue); color: white; }
        .timeline { display: flex; flex-direction: column; gap: 12px; }
        .brick { background: var(--brick-blue); border-radius: 8px; padding: 20px; border-left: 12px solid rgba(0,0,0,0.3); position: relative; }
        .brick.meeting-nested { background: var(--brick-purple); }
        .nested-event { background: rgba(0,0,0,0.2); margin-top: 10px; padding: 10px; border-radius: 6px; font-size: 0.9em; border-left: 3px solid #fff; }
        .time-label { font-size: 0.8em; opacity: 0.7; display: block; }
    </style>
</head>
<body>

<div class="container">
    <div class="config-bar">
        <input type="text" id="cal-token" placeholder="1. Paste Token Here">
        <input type="text" id="user-uri" placeholder="2. User URI will appear here">
        <button class="btn-uri" onclick="findMyUri()">Step 1: Get URI</button>
        <button class="btn-sync" onclick="refreshDashboard()">Step 2: Sync Dashboard</button>
    </div>

    <div class="config-bar" style="background: #333; justify-content: center;">
        <label for="date-select">ðŸ“… View Date: </label>
        <input type="date" id="date-select" onchange="ScheduleManager.changeDate(this.value)">
        <button onclick="ScheduleManager.resetToday()" style="background: #555; color: white;">Reset to Today</button>
    </div>

    <div id="status-header" style="text-align: center; margin-bottom: 20px;">
        <h2 id="current-day-display">Loading...</h2>
        <p id="day-note" style="color: #f1c40f; font-weight: bold;"></p>
    </div>

    <div id="dashboard" class="timeline"></div>
</div>
<script>
/**
 * 1. DATA & TEMPLATES
 */
let scheduleState = {
    currentCycle: null,
    note: "",
    dailyBlocks: [],
    meetings: [],
    coziEvents: [] // Placeholder for Cozi data
};

const templates = {
    // RESTORED: Checklists added back to base blocks
    base: [
        { 
            name: "Morning Routine", 
            start: "05:30", 
            end: "06:30", 
            tasks: ["Feed Dog", "Breakfast", "Coffee", "Water", "Get Ready"] 
        },
        { name: "Travel", start: "06:30", end: "07:15" },
        { name: "After School Admin", start: "15:00", end: "17:00" },
        { name: "PM Cleanup", start: "19:00", end: "20:30", tasks: ["Dishes", "Prep Coffee"] }
    ],
    cicloA: [
        { name: "Block 1A", start: "07:15", end: "08:45" },
        { name: "Block 2A", start: "08:51", end: "10:21" },
        { name: "Lunch", start: "10:27", end: "10:57" },
        { name: "Block 3A", start: "11:03", end: "12:32" },
        { name: "Block 4A", start: "12:38", end: "14:09" }
    ],
    cicloB: [
        { name: "Block 1B", start: "07:15", end: "08:45" },
        { name: "Block 2B", start: "08:51", end: "10:21" },
        { name: "Lunch", start: "10:27", end: "10:57" },
        { name: "Block 3B", start: "11:03", end: "12:32" },
        { name: "Block 4B", start: "12:38", end: "14:09" }
    ]
};

/**
 * 4. THE PAINTER (Updated for Checklists)
 */
const UIRenderer = {
    render: () => {
        const container = document.getElementById('dashboard');
        if(!container) return;
        container.innerHTML = "";
        
        // ... (Header logic stays the same) ...

        const sorted = [...scheduleState.dailyBlocks].sort((a, b) => 
            TimeEngine.toMins(a.start) - TimeEngine.toMins(b.start)
        );

        const globalAddedMeetings = new Set();

        sorted.forEach((block) => {
            const brick = document.createElement('div');
            brick.className = 'brick';
            
            // Build the Brick content
            let content = `<span class="time-label">${block.start} - ${block.end}</span>`;
            content += `<strong>${block.name}</strong>`;
            
            // NEW: Render the Task Checklist if it exists
            if (block.tasks && block.tasks.length > 0) {
                content += `<ul class="task-list" style="margin-top:10px; padding-left:20px; font-size:0.85em;">`;
                block.tasks.forEach(task => {
                    content += `<li>${task}</li>`;
                });
                content += `</ul>`;
            }

            brick.innerHTML = content;

            // ... (Meeting nesting logic stays the same) ...
            
            container.appendChild(brick);
        });
    }
};

/**
 * 6. COZI INTEGRATION (The Strategy)
 */
async function syncCozi() {
    // Strategy: Cozi provides a "Shared Calendar" URL ending in .ics
    // We will need to fetch that URL and parse it.
    console.log("Cozi Sync initiated. Awaiting .ics URL.");
    // In the next step, we'll add an input for your Cozi ICS link.
}
</script>
</body>
</html>
