<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Lego Dashboard & House Hub</title>
    <style>
        :root {
            --bg: #121212;
            --brick-blue: #3498db;
            --brick-purple: #9b59b6;
            --ghost-border: #444;
            --text: #ffffff;
        }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); padding: 20px; }
        .container { max-width: 800px; margin: auto; }
        
        .config-bar { background: #222; padding: 15px; border-radius: 10px; margin-bottom: 30px; display: flex; flex-wrap: wrap; gap: 10px; }
        input { background: #fff; color: #000; border: 1px solid #555; padding: 10px; border-radius: 5px; flex: 1; min-width: 200px; }
        button { cursor: pointer; padding: 10px 15px; border-radius: 5px; border: none; font-weight: bold; }
        .btn-uri { background: #f1c40f; color: black; }
        .btn-sync { background: var(--brick-blue); color: white; }
        
        .timeline { display: flex; flex-direction: column; gap: 12px; }
        .brick { background: var(--brick-blue); border-radius: 8px; padding: 20px; border-left: 12px solid rgba(0,0,0,0.3); position: relative; }
        .brick.meeting-nested { background: var(--brick-purple); }
        
        .ghost-brick { border: 2px dashed var(--ghost-border); border-radius: 8px; padding: 15px; text-align: center; cursor: pointer; color: #888; }
        .ghost-brick:hover { border-color: var(--brick-blue); color: var(--brick-blue); background: rgba(52, 152, 219, 0.05); }

        .nested-event { background: rgba(0,0,0,0.2); margin-top: 10px; padding: 10px; border-radius: 6px; font-size: 0.9em; border-left: 3px solid #fff; }
        .time-label { font-size: 0.8em; opacity: 0.7; display: block; }
    </style>
</head>
<body>

<div class="container">
    <div class="config-bar">
        <input type="text" id="cal-token" placeholder="1. Paste Token Here">
        <input type="text" id="user-uri" placeholder="2. User URI will appear here">
        <button class="btn-uri" onclick="findMyUri()">Step 1: Get URI</button>
        <button class="btn-sync" onclick="refreshDashboard()">Step 2: Sync Dashboard</button>
    </div>

    <div id="dashboard" class="timeline"></div>
</div>
<script>
/**
 * SECTION: DATA & CONFIGURATION
 * This is where we define what's inside the "A" and "B" buckets.
 */
let scheduleState = {
    currentCycle: null, 
    note: "",           
    dailyBlocks: [],    
    meetings: []
};

// Templates: Edit these once, and they update every time that day cycles back.
const templates = {
    base: [
        { name: "Morning Routine", start: "07:00", end: "08:15", checklist: ["Feed Dog", "Eat Breakfast", "Get Ready"] },
        { name: "Travel", start: "08:15", end: "08:45" },
        { name: "After School", start: "15:00", end: "17:00" },
        { name: "Evening Routine", start: "18:00", end: "21:00" }
    ],
    cicloA: [
        { name: "Block 1A", start: "08:45", end: "10:15" },
        { name: "Block 2A", start: "10:20", end: "11:50" },
        { name: "Block 3A", start: "12:30", end: "13:30" },
        { name: "Block 4A", start: "13:35", end: "15:00" }
    ],
    cicloB: [
        { name: "Block 1B", start: "08:45", end: "10:15" },
        { name: "Block 2B", start: "10:20", end: "11:50" },
        { name: "Block 3B", start: "12:30", end: "13:30" },
        { name: "Block 4B", start: "13:35", end: "15:00" }
    ]
};

/**
 * SECTION: SCHEDULE MANAGER
 * Fetches your GitHub JSON and picks the right template.
 */
const ScheduleManager = {
    jsonUrl: "https://raw.githubusercontent.com/scottscalici/imagenes/refs/heads/main/planes/calendario.json",

    init: async () => {
        try {
            const response = await fetch(ScheduleManager.jsonUrl);
            const data = await response.json();
            
            // Get today's date in YYYY-MM-DD format
            const today = new Date().toISOString().split('T')[0];
            
            // Find today's entry in your JSON map
            const dayInfo = data.map.find(item => item.fecha === today);

            if (dayInfo) {
                scheduleState.currentCycle = dayInfo.ciclo;
                scheduleState.note = dayInfo.note || "";
                ScheduleManager.buildDailySchedule(dayInfo.ciclo);
            } else {
                // If weekend or not found, just show base routine
                scheduleState.dailyBlocks = [...templates.base];
            }
            
            UIRenderer.render();
        } catch (e) {
            console.error("Error loading calendar:", e);
            // Fallback so the app doesn't break if GitHub is down
            scheduleState.dailyBlocks = [...templates.base];
            UIRenderer.render();
        }
    },

    buildDailySchedule: (ciclo) => {
        let blocks = [...templates.base];
        
        if (ciclo === "A") {
            blocks = [...blocks, ...templates.cicloA];
        } else if (ciclo === "B") {
            blocks = [...blocks, ...templates.cicloB];
        }

        scheduleState.dailyBlocks = blocks;
    }
};

    /**
 * SECTION: THE PAINTER (UI Rendering)
 * Only responsible for putting things on the screen.
 */
const UIRenderer = {
    render: () => {
        const container = document.getElementById('dashboard');
        container.innerHTML = "";
        
        const sorted = TimeEngine.sortBlocks(scheduleState.dailyBlocks);

        sorted.forEach((block, index) => {
            // 1. Check for Gaps (Ghost Blocks)
            if (index > 0) {
                const prevEnd = sorted[index - 1].end;
                if (TimeEngine.toMins(prevEnd) < TimeEngine.toMins(block.start)) {
                    container.appendChild(UIRenderer.createGhost(prevEnd, block.start));
                }
            }

            // 2. Build the Brick
            const brick = document.createElement('div');
            brick.className = 'brick';
            
            // Checkbox logic for blocks with lists
            let checklistHtml = '';
            if (block.checklist) {
                checklistHtml = `<ul style="list-style:none; padding:0; margin-top:10px;">` + 
                    block.checklist.map(item => `<li><input type="checkbox"> ${item}</li>`).join('') + 
                    `</ul>`;
            }

            brick.innerHTML = `
                <span class="time-label">${block.start} - ${block.end}</span>
                <strong>${block.name}</strong>
                ${checklistHtml}
            `;

            // 3. Nest Meetings
            scheduleState.meetings.forEach(m => {
                const mTime = new Date(m.start_time).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', hour12: false });
                if (mTime >= block.start && mTime < block.end) {
                    brick.classList.add('meeting-nested');
                    brick.innerHTML += `<div class="nested-event"><strong>ðŸ“… ${m.name}</strong> at ${mTime}</div>`;
                }
            });

            container.appendChild(brick);
        });
    },

    createGhost: (start, end) => {
        const div = document.createElement('div');
        div.className = 'ghost-brick';
        div.innerHTML = `+ Add Task (${start} - ${end})`;
        div.onclick = () => {
            const name = prompt("What's happening in this gap?");
            if (name) {
                scheduleState.dailyBlocks.push({ name, start, end });
                UIRenderer.render();
            }
        };
        return div;
    }
};

/**
 * SECTION: EXTERNAL INTEGRATIONS
 * Calendly, Cozy, etc.
 */
async function findMyUri() {
    const token = document.getElementById('cal-token').value.trim();
    if (!token) return alert("Paste token!");
    try {
        const target = "https://api.calendly.com/users/me";
        const res = await fetch(PROXY + encodeURIComponent(target), {
            headers: { 'Authorization': `Bearer ${token}` }
        });
        const data = await res.json();
        document.getElementById('user-uri').value = data.resource.uri;
    } catch (e) { console.error(e); }
}

async function refreshDashboard() {
    const token = document.getElementById('cal-token').value.trim();
    const userUri = document.getElementById('user-uri').value.trim();
    try {
        const target = `https://api.scheduled_events?user=${userUri}&status=active`;
        const res = await fetch(PROXY + encodeURIComponent(target), {
            headers: { 'Authorization': `Bearer ${token}` }
        });
        const data = await res.json();
        scheduleState.meetings = data.collection || [];
        UIRenderer.render();
    } catch (e) { alert("Sync failed."); }
}

// Initial Boot
UIRenderer.render();
ScheduleManager.init();

</script>
</body>
</html>
