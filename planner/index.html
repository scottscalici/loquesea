<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Lego Dashboard & House Hub</title>
    <style>
        :root {
            --bg: #121212;
            --brick-blue: #3498db;
            --brick-purple: #9b59b6;
            --brick-green: #27ae60;
            --text: #ffffff;
        }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); padding: 20px; }
        .container { max-width: 800px; margin: auto; }
        .config-bar { background: #222; padding: 15px; border-radius: 10px; margin-bottom: 30px; display: flex; flex-wrap: wrap; gap: 10px; }
        input { background: #fff; color: #000; border: 1px solid #555; padding: 10px; border-radius: 5px; flex: 1; min-width: 200px; }
        button { cursor: pointer; padding: 10px 15px; border-radius: 5px; border: none; font-weight: bold; }
        .btn-uri { background: #f1c40f; color: black; }
        .btn-sync { background: var(--brick-blue); color: white; }
        .timeline { display: flex; flex-direction: column; gap: 12px; }
        .brick { background: var(--brick-blue); border-radius: 8px; padding: 20px; border-left: 12px solid rgba(0,0,0,0.3); position: relative; }
        .brick.meeting-nested { background: var(--brick-purple); }
        .nested-event { background: rgba(0,0,0,0.2); margin-top: 10px; padding: 10px; border-radius: 6px; font-size: 0.9em; border-left: 3px solid #fff; }
        .time-label { font-size: 0.8em; opacity: 0.7; display: block; }
        .all-day-tag { background: var(--brick-green); padding: 8px 15px; border-radius: 20px; font-weight: bold; font-size: 0.85em; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
    </style>
</head>
<body>

<div class="container">
    <div class="config-bar">
        <input type="text" id="cal-token" placeholder="1. Paste Token Here">
        <input type="text" id="user-uri" placeholder="2. User URI will appear here">
        <button class="btn-uri" onclick="findMyUri()">Step 1: Get URI</button>
        <button class="btn-sync" onclick="refreshDashboard()">Step 2: Sync Dashboard</button>
    </div>

    <div class="config-bar" style="background: #333; justify-content: center;">
        <label for="date-select">üìÖ View Date: </label>
        <input type="date" id="date-select" onchange="ScheduleManager.changeDate(this.value)">
        <button onclick="ScheduleManager.resetToday()" style="background: #555; color: white;">Reset to Today</button>
    </div>

    <div id="status-header" style="text-align: center; margin-bottom: 20px;">
        <h2 id="current-day-display">Initializing...</h2>
        <p id="day-note" style="color: #f1c40f; font-weight: bold;"></p>
    </div>

    <div id="dashboard" class="timeline"></div>
</div>

<script>

let scheduleState = {
    currentCycle: null,
    note: "",
    dailyBlocks: [],
    meetings: [],
    coziEvents: [] 
};

const templates = {
    base: [
        { name: "Morning Routine", start: "05:30", end: "06:30", tasks: ["Feed Dog", "Breakfast", "Coffee", "Water", "Get Ready"] },
        { name: "Travel", start: "06:30", end: "07:15" },
        { name: "After School Admin", start: "15:00", end: "17:00" },
        { name: "PM Cleanup", start: "19:00", end: "20:30", tasks: ["Dishes", "Prep Coffee"] }
    ],
    cicloA: [
        { name: "Block 1A", start: "07:15", end: "08:45" },
        { name: "Block 2A", start: "08:51", end: "10:21" },
        { name: "Lunch", start: "10:27", end: "10:57" },
        { name: "Block 3A", start: "11:03", end: "12:32" },
        { name: "Block 4A", start: "12:38", end: "14:09" }
    ],
    cicloB: [
        { name: "Block 1B", start: "07:15", end: "08:45" },
        { name: "Block 2B", start: "08:51", end: "10:21" },
        { name: "Lunch", start: "10:27", end: "10:57" },
        { name: "Block 3B", start: "11:03", end: "12:32" },
        { name: "Block 4B", start: "12:38", end: "14:09" }
    ]
};

const PROXY = "https://corsproxy.io/?";

const TimeEngine = {
    toMins: (t) => {
        if(!t || !t.includes(':')) return -1;
        const [h, m] = t.split(':').map(Number);
        return h * 60 + m;
    },
    parseIcsDate: (icsStr) => {
        if(!icsStr) return null;
        // Strip everything before the colon (like DTSTART;VALUE=DATE:)
        const val = icsStr.includes(':') ? icsStr.split(':').pop() : icsStr;
        const cleanStr = val.trim();
        
        const y = cleanStr.substring(0,4);
        const m = cleanStr.substring(4,6);
        const d = cleanStr.substring(6,8);
        const dateStr = `${y}-${m}-${d}`;

        if (!cleanStr.includes('T')) {
            return { dateStr, isAllDay: true };
        }

        const h = cleanStr.substring(9,11);
        const min = cleanStr.substring(11,13);
        
        return {
            dateStr,
            timeStr: `${h}:${min}`,
            isAllDay: false
        };
    }
};

const UIRenderer = {
    render: () => {
        const container = document.getElementById('dashboard');
        const head = document.getElementById('current-day-display');
        if(!container) return;
        container.innerHTML = "";

        head.innerText = `View: ${ScheduleManager.selectedDate} ${scheduleState.currentCycle ? '(Cycle ' + scheduleState.currentCycle + ')' : ''}`;

        // 1. Render All-Day Events
        const allDayZone = document.createElement('div');
        allDayZone.style = "display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 20px;";
        container.appendChild(allDayZone);

        scheduleState.coziEvents.forEach(e => {
            if (e.dateStr === ScheduleManager.selectedDate && e.isAllDay) {
                const tag = document.createElement('div');
                tag.className = 'all-day-tag';
                tag.innerText = `üåü ${e.summary}`;
                allDayZone.appendChild(tag);
            }
        });

        // 2. Render Time Bricks
        const sorted = [...scheduleState.dailyBlocks].sort((a, b) => 
            TimeEngine.toMins(a.start) - TimeEngine.toMins(b.start)
        );

        sorted.forEach((block) => {
            const brick = document.createElement('div');
            brick.className = 'brick';
            let content = `<span class="time-label">${block.start} - ${block.end}</span><strong>${block.name}</strong>`;

            if (block.tasks) {
                content += `<ul style="margin: 10px 0 0 20px; font-size: 0.85em; list-style: circle;">`;
                block.tasks.forEach(t => content += `<li>${t}</li>`);
                content += `</ul>`;
            }

            brick.innerHTML = content;
            const bStart = TimeEngine.toMins(block.start);
            const bEnd = TimeEngine.toMins(block.end);

            // Nest Calendly
            scheduleState.meetings.forEach(m => {
                const mDate = new Date(m.start_time);
                const mTime = mDate.getHours().toString().padStart(2,'0') + ":" + mDate.getMinutes().toString().padStart(2,'0');
                if (mDate.toISOString().split('T')[0] === ScheduleManager.selectedDate) {
                    if (TimeEngine.toMins(mTime) >= bStart && TimeEngine.toMins(mTime) < bEnd) {
                        brick.classList.add('meeting-nested');
                        brick.innerHTML += `<div class="nested-event"><strong>üìÖ ${m.name}</strong> at ${mTime}</div>`;
                    }
                }
            });

            // Nest Cozi (Timed) - Aggressive catch
            scheduleState.coziEvents.forEach(e => {
                if (e.dateStr === ScheduleManager.selectedDate && !e.isAllDay) {
                    const eMins = TimeEngine.toMins(e.timeStr);
                    if (eMins >= bStart && eMins < bEnd) {
                        brick.classList.add('meeting-nested');
                        brick.style.borderLeftColor = "#27ae60"; 
                        brick.innerHTML += `<div class="nested-event" style="border-left: 3px solid #2ecc71;"><strong>üè† ${e.summary}</strong> at ${e.timeStr}</div>`;
                    }
                }
            });

            container.appendChild(brick);
        });
    }
};

async function syncCozi() {
    try {
        const res = await fetch(PROXY + encodeURIComponent(ScheduleManager.coziUrl));
        let text = await res.text();
        
        // FIX 1: "Unfold" the ICS file (remove line breaks that split words)
        text = text.replace(/\r\n /g, ''); 
        
        const events = [];
        const vevents = text.split("BEGIN:VEVENT");
        
        // Skip the first chunk (it's the header)
        for (let i = 1; i < vevents.length; i++) {
            const chunk = vevents[i];
            
            // FIX 2: Better matching for summaries and dates
            const summaryMatch = chunk.match(/SUMMARY:(.*)/);
            const dtStartMatch = chunk.match(/DTSTART[^:]*:(.*)/);
            
            if (summaryMatch && dtStartMatch) {
                const info = TimeEngine.parseIcsDate(dtStartMatch[1].trim());
                if (info) {
                    events.push({
                        summary: summaryMatch[1].trim().replace(/\\,/g, ','), // fix commas
                        dateStr: info.dateStr,
                        timeStr: info.timeStr,
                        isAllDay: info.isAllDay
                    });
                }
            }
        }

        scheduleState.coziEvents = events;
        UIRenderer.render();
    } catch (e) { console.error("Sync error", e); }
}

const ScheduleManager = {
    jsonUrl: "https://raw.githubusercontent.com/scottscalici/imagenes/refs/heads/main/planes/calendario.json",
    coziUrl: "https://rest.cozi.com/api/ext/1103/f9f7020d-05c9-4720-b813-2155b4485be7/icalendar/feed/feed.ics",
    selectedDate: new Date().toISOString().split('T')[0],

    init: async () => {
        const dateInput = document.getElementById('date-select');
        if(dateInput) dateInput.value = ScheduleManager.selectedDate;

        const sToken = localStorage.getItem('saved_cal_token');
        const sUri = localStorage.getItem('saved_cal_uri');
        if (sToken) document.getElementById('cal-token').value = sToken;
        if (sUri) document.getElementById('user-uri').value = sUri;

        await ScheduleManager.loadFromGitHub();
        if (sToken && sUri) refreshDashboard();
        syncCozi();
    },

    changeDate: (val) => {
        ScheduleManager.selectedDate = val;
        ScheduleManager.loadFromGitHub();
        refreshDashboard();
        syncCozi();
    },

    resetToday: () => {
        ScheduleManager.selectedDate = new Date().toISOString().split('T')[0];
        document.getElementById('date-select').value = ScheduleManager.selectedDate;
        ScheduleManager.changeDate(ScheduleManager.selectedDate);
    },

    loadFromGitHub: async () => {
        try {
            const res = await fetch(ScheduleManager.jsonUrl);
            const data = await res.json();
            const dayInfo = data.map.find(item => item.fecha === ScheduleManager.selectedDate);
            scheduleState.currentCycle = dayInfo?.ciclo || null;
            scheduleState.note = dayInfo?.note || "";
            let blocks = [...templates.base];
            if (scheduleState.currentCycle === "A") blocks = [...blocks, ...templates.cicloA];
            if (scheduleState.currentCycle === "B") blocks = [...blocks, ...templates.cicloB];
            scheduleState.dailyBlocks = blocks;
            UIRenderer.render();
        } catch (e) {
            scheduleState.dailyBlocks = [...templates.base];
            UIRenderer.render();
        }
    }
};

const UIRenderer = {
    render: () => {
        const container = document.getElementById('dashboard');
        const head = document.getElementById('current-day-display');
        const note = document.getElementById('day-note');
        if(!container) return;
        container.innerHTML = "";

        head.innerText = `View: ${ScheduleManager.selectedDate} ${scheduleState.currentCycle ? '(Cycle ' + scheduleState.currentCycle + ')' : ''}`;
        note.innerText = scheduleState.note;

        // All Day Section
        const allDayZone = document.createElement('div');
        allDayZone.style = "display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 20px;";
        container.appendChild(allDayZone);

        scheduleState.coziEvents.forEach(e => {
            if (e.dateStr === ScheduleManager.selectedDate && e.isAllDay) {
                const tag = document.createElement('div');
                tag.className = 'all-day-tag';
                tag.innerText = `üåü ${e.summary}`;
                allDayZone.appendChild(tag);
            }
        });

        const sorted = [...scheduleState.dailyBlocks].sort((a, b) => 
            TimeEngine.toMins(a.start) - TimeEngine.toMins(b.start)
        );

        sorted.forEach((block) => {
            const brick = document.createElement('div');
            brick.className = 'brick';
            let content = `<span class="time-label">${block.start} - ${block.end}</span><strong>${block.name}</strong>`;

            if (block.tasks) {
                content += `<ul style="margin: 10px 0 0 20px; font-size: 0.85em; list-style: circle;">`;
                block.tasks.forEach(t => content += `<li>${t}</li>`);
                content += `</ul>`;
            }

            brick.innerHTML = content;
            const bStart = TimeEngine.toMins(block.start);
            const bEnd = TimeEngine.toMins(block.end);

            // NESTING: Calendly (Multiple allowed)
            scheduleState.meetings.forEach(m => {
                const mDate = new Date(m.start_time);
                // Get local time HH:mm
                const mTime = mDate.getHours().toString().padStart(2,'0') + ":" + mDate.getMinutes().toString().padStart(2,'0');
                const mMins = TimeEngine.toMins(mTime);
                
                if (mDate.toISOString().split('T')[0] === ScheduleManager.selectedDate) {
                    if (mMins >= bStart && mMins < bEnd) {
                        brick.classList.add('meeting-nested');
                        brick.innerHTML += `<div class="nested-event"><strong>üìÖ ${m.name}</strong> at ${mTime}</div>`;
                    }
                }
            });

            // NESTING: Cozi (Multiple allowed)
            scheduleState.coziEvents.forEach(e => {
                if (e.dateStr === ScheduleManager.selectedDate && !e.isAllDay) {
                    const eMins = TimeEngine.toMins(e.timeStr);
                    if (eMins >= bStart && eMins < bEnd) {
                        brick.classList.add('meeting-nested');
                        brick.style.borderLeftColor = "#27ae60"; 
                        brick.innerHTML += `<div class="nested-event" style="border-left: 3px solid #2ecc71;"><strong>üè† ${e.summary}</strong> at ${e.timeStr}</div>`;
                    }
                }
            });

            container.appendChild(brick);
        });
    }
};

async function findMyUri() {
    const token = document.getElementById('cal-token').value.trim();
    if (!token) return alert("Paste token first!");
    localStorage.setItem('saved_cal_token', token);
    try {
        const res = await fetch(PROXY + encodeURIComponent("https://api.calendly.com/users/me"), {
            headers: { 'Authorization': `Bearer ${token}`, 'Accept': 'application/json' }
        });
        const data = await res.json();
        if (data.resource) {
            document.getElementById('user-uri').value = data.resource.uri;
            localStorage.setItem('saved_cal_uri', data.resource.uri);
            alert("URI Saved!");
        }
    } catch (e) { alert("Error: " + e.message); }
}

async function refreshDashboard() {
    const token = document.getElementById('cal-token').value.trim();
    const uri = document.getElementById('user-uri').value.trim();
    if (!token || !uri) return;
    try {
        const target = `https://api.calendly.com/scheduled_events?user=${uri}&status=active&min_start_time=${ScheduleManager.selectedDate}T00:00:00Z&max_start_time=${ScheduleManager.selectedDate}T23:59:59Z`;
        const res = await fetch(PROXY + encodeURIComponent(target), {
            headers: { 'Authorization': `Bearer ${token}`, 'Accept': 'application/json' }
        });
        const data = await res.json();
        scheduleState.meetings = data.collection || [];
        UIRenderer.render();
    } catch (e) { console.error(e); }
}

async function syncCozi() {
    try {
        const res = await fetch(PROXY + encodeURIComponent(ScheduleManager.coziUrl));
        const text = await res.text();
        const events = [];
        const chunks = text.split("BEGIN:VEVENT");
        chunks.forEach(chunk => {
            const summaryMatch = chunk.match(/SUMMARY:(.*)/);
            const dtStartMatch = chunk.match(/DTSTART;?[^:]*:(.*)/);
            if (summaryMatch && dtStartMatch) {
                const info = TimeEngine.parseIcsDate(dtStartMatch[1].trim());
                if (info) {
                    events.push({
                        summary: summaryMatch[1].trim(),
                        dateStr: info.dateStr,
                        timeStr: info.timeStr,
                        isAllDay: info.isAllDay
                    });
                }
            }
        });
        scheduleState.coziEvents = events;
        UIRenderer.render();
    } catch (e) { console.error(e); }
}

window.onload = () => {
    ScheduleManager.init();
};

</script>
</body>
</html>
