<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Weekly Budget</title>
    <style>
        :root { --primary: #2e7d32; --accent: #2196F3; --bg: #f4f4f9; --card: #ffffff; --text: #333; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); margin: 0; padding: 15px; padding-top: 60px; color: var(--text); }
        .nav-bar { position: fixed; top: 0; left: 0; right: 0; height: 50px; background: #fff; display: flex; align-items: center; justify-content: space-around; border-bottom: 1px solid #ddd; z-index: 1000; }
        .nav-item { text-decoration: none; color: #666; font-size: 0.75rem; font-weight: bold; }
        .nav-item.active { color: var(--accent); }
        .card { background: var(--card); border-radius: 12px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-bottom: 15px; text-align: center; }
        .label { font-size: 0.8rem; color: #888; text-transform: uppercase; letter-spacing: 1px; }
        .big-amt { font-size: 2.5rem; font-weight: 800; margin: 10px 0; display: block; }
        .progress-container { background: #eee; height: 12px; border-radius: 6px; margin: 20px 0; overflow: hidden; }
        .progress-bar { background: var(--primary); height: 100%; transition: width 0.5s ease; }
        .stats { display: flex; justify-content: space-between; margin-top: 10px; font-weight: bold; }
        .history-item { display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid #eee; font-size: 0.9rem; }
    </style>
</head>
<body>

    <div class="card">
        <span class="label">Remaining This Week</span>
        <span id="weeklyRemaining" class="big-amt">$0</span>
        
        <div class="progress-container">
            <div id="progressBar" class="progress-bar" style="width: 0%"></div>
        </div>

        <div class="stats">
            <div><span class="label">Spent</span><br><span id="weeklySpent" style="color:#d32f2f;">$0</span></div>
            <div><span class="label">Budget</span><br><span>$1,000</span></div>
        </div>
    </div>

    <div class="card" style="text-align: left;">
        <span class="label">This Week's Spending</span>
        <div id="weeklyList" style="margin-top:10px;"></div>
    </div>

<script>
    async function init() {
        const resp = await fetch(`bills.json?t=${Date.now()}`);
        const data = await resp.json();
        updateUI(data);
    }

    function updateUI(data) {
        // 1. Define this week (Monday start)
        const now = new Date();
        const day = now.getDay();
        const diff = now.getDate() - day + (day === 0 ? -6 : 1);
        const monday = new Date(now.setDate(diff));
        monday.setHours(0,0,0,0);

        // 2. FILTER & SUM EVERYTHING (EXCEL-STYLE)
        // Find all history items that happened since Monday
        const thisWeeksItems = data.history.filter(h => {
            const hDate = new Date(h.date);
            return hDate >= monday;
        });

        // Sum up the absolute total of those items
        const spent = thisWeeksItems.reduce((sum, item) => sum + Math.abs(item.amount), 0);
        
        // 3. APPLY TO BUDGET ($1,000 Weekly Allowance)
        const budget = 1000;
        const remaining = budget - spent;
        const pct = Math.min((spent / budget) * 100, 100);

        // 4. Update UI Elements
        document.getElementById('weeklyRemaining').innerText = `$${remaining.toLocaleString()}`;
        document.getElementById('weeklySpent').innerText = `$${spent.toLocaleString()}`;
        document.getElementById('progressBar').style.width = pct + '%';
        
        // Update Color based on spending
        if (remaining < 200) document.getElementById('weeklyRemaining').style.color = '#d32f2f';
        else document.getElementById('weeklyRemaining').style.color = '#2e7d32';

        // 5. Render List
        const list = document.getElementById('weeklyList');
        list.innerHTML = '';
        thisWeeksItems.reverse().forEach(item => {
            const dt = new Date(item.date);
            list.innerHTML += `
                <div class="history-item">
                    <div>
                        <b>${item.what || item.vendor}</b><br>
                        <small style="color:#888;">${dt.getMonth()+1}/${dt.getDate()}</small>
                    </div>
                    <span style="color:#d32f2f; font-weight:bold;">-$${item.amount.toLocaleString()}</span>
                </div>`;
        });
    }

    init();
</script>
</body>
</html>
